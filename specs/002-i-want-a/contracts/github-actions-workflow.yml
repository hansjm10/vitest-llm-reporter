# GitHub Actions Workflow Contract
# This defines the expected structure and behavior of CI/CD workflows

# CI Workflow Contract
name: CI Workflow Contract
description: |
  Validates pull requests and pushes to main branch
  Must run all quality checks and report status

contract:
  triggers:
    required:
      - pull_request:
          types: [opened, synchronize, reopened]
          branches: [main, master]
      - push:
          branches: [main, master]

  jobs:
    test:
      required: true
      outputs:
        - coverage-report
        - test-results
      matrix:
        node-version: [17, 18, 20, 22]
        os: [ubuntu-latest]
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
        - run: npm ci
        - run: npm test
        - run: npm run coverage

    lint:
      required: true
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
        - run: npm ci
        - run: npm run lint

    type-check:
      required: true
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
        - run: npm ci
        - run: npm run type-check

    build:
      required: true
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
        - run: npm ci
        - run: npm run build

  status_checks:
    required:
      - test
      - lint
      - type-check
      - build
      - coverage

  artifacts:
    test-results:
      path: test-results/
      retention: 7 days
    coverage:
      path: coverage/
      retention: 7 days

---

# Release Workflow Contract
name: Release Workflow Contract
description: |
  Publishes packages to NPM on release creation
  Requires manual trigger via GitHub Release

contract:
  triggers:
    required:
      - release:
          types: [published]

  permissions:
    contents: read
    packages: write
    id-token: write  # For provenance

  secrets:
    required:
      - NPM_TOKEN

  jobs:
    validate:
      required: true
      strategy:
        matrix:
          os: [ubuntu-latest, windows-latest, macos-latest]
          node-version: [17, 18, 20, 22]

    publish:
      required: true
      needs: [validate]
      environment: npm-production
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
          with:
            registry-url: 'https://registry.npmjs.org'
        - run: npm ci --ignore-scripts
        - run: npm run build
        - run: npm publish
          env:
            NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  validation:
    - version_not_exists
    - package_json_valid
    - all_tests_pass
    - npm_token_valid